// Shell// Adam Riggs// 2/25/2011//package{		import flash.display.Sprite;	import flash.display.MovieClip;	import flash.display.Loader;	import flash.net.URLLoader;	import flash.net.URLRequest;	import flash.events.*;	import flash.events.ProgressEvent;	import flash.system.Capabilities;		import com.adam.db.SQLProxy;	import com.adam.db.Database;	import com.adam.events.EventManager;	import com.adam.events.MuleEvent;	import com.adam.utils.AppData;	import com.adam.utils.Bandwidth;		import com.app.Main;		import gs.TweenLite;		public class Shell extends Sprite{				private var main:Sprite;		private var mainLoader:Loader;				//progress bar variables		private var progressBar:Sprite;		private var progressW:int;		private var progressH:int;		private var progressFill:int;		private var progressBkg:int;				//bandwidth variables;		/*private var bandwidth:Object;		private var bandwidthProgress:Object;*/		private var bandwidth:Bandwidth;				private var xmlLoader:URLLoader;				private var doneAA:Object;		private var isDone:Boolean;				private var appData:AppData=AppData.instance;				public function Shell():void{			init();		}//*****Initialization Routines				public function init():void{			trace("Shell init()");						appData.shell=this;			appData.playerType=flash.system.Capabilities.playerType;			appData.buildType="product";						initDoneArray();			initBandwidth();			initEventManager();			initFlashVars();			initSQL();			initDatabase();			//initXML();	//initXML() is called after the flashVars are loaded			initStage();			initProgressBar();			//initMain();		//initMain() is called after everything else is done loading, i.e. the doneAA is all true		}				private function initDoneArray():void{			trace("Shell initDoneArray()");			//creat an associative array with boolean flags that			//are flipped to true when an initalization operation is completed.						//register all here			doneAA=new Object();			doneAA.eventManagerDone=false;			doneAA.fvDone=false;			//doneAA.sqlDone=false;			doneAA.databaseDone=false;			doneAA.xmlDone=false;			doneAA.stageDone=false;		}				private function initBandwidth():void{			trace("Shell initBandwidth()");			//initialize the bandwidth measuring object			bandwidth=new Bandwidth;			appData.bandwidth=bandwidth;		}				private function initEventManager():void{			trace("Shell initEventManager()");			appData.eventManager=EventManager.instance;			doneAA.eventManagerDone=true;		}				private function initFlashVars():void{			trace("Shell initFlashVars()");			//read in the flash vars			loaderInfo.addEventListener(Event.COMPLETE, onLoaderComplete);		}				private function initSQL():void{			trace("Shell initSQLProxy()");			appData.sqlProxy=SQLProxy.instance;			appData.sqlProxy.init();			doneAA.sqlDone=true;						/*var vars:URLVariables=new URLVariables();			vars.table="participant";			vars.test=new Date().time.toString();			vars.subject="420_69";			appData.sqlProxy.insertSQL(vars);*/		}				private function initDatabase():void{			appData.database=Database.instance;			appData.database.init();			doneAA.databaseDone=true;		}				private function initXML():void{			trace("Shell initXML()");			//load the main xml file			//this isnt' called until onLoaderComplete in case the flashvars have the xml file address			var url:String;			if(appData.flashVars.xml){				url=appData.flashVars.xml			} else {				url="Main/main.xml";			}			xmlLoader=new URLLoader(new URLRequest(url));			xmlLoader.addEventListener("complete", onXMLLoaded);		}				private function initStage():void{			trace("Shell initStage()");			addEventListener(Event.ADDED_TO_STAGE, onAddedToStage);		}				private function initMain():void{			trace("Shell initMain()");			//this is for directly instantiating the main			/*main=new Main();			startMain();*/						//this is for loading the Main.swf			mainLoader=new Loader();			mainLoader.contentLoaderInfo.addEventListener("complete", onMainLoaded);			mainLoader.contentLoaderInfo.addEventListener("progress", onMainProgress);			mainLoader.load(new URLRequest("Main/Main.swf"));						//start keeping track of download time			bandwidth.startTime=new Date();					}				private function initProgressBar():void{			//progressBar should really be it's own class.						progressW=100;			progressH=3;			progressFill=0x333333;			progressBkg=0xCCCCCC;						progressBar=new Sprite();			progressBar.graphics.lineStyle(progressH,progressBkg);			progressBar.graphics.moveTo(0, 0);			progressBar.graphics.lineTo(progressW, 0);			addChild(progressBar);						progressBar.graphics.moveTo(0, 0);						progressBar.x=(stage.stageWidth-progressW)/2;			progressBar.y=(stage.stageHeight-progressH)/2;			//progressBar.alpha=0;		}//*****Core Functionality				private function checkDone():void{			trace("Shell checkDone()");			//check if everything is done			isDone=true;			for(var item in doneAA){				if(doneAA[item]==false){isDone=false;}			}						if(isDone){				done();			}		}				private function done():void{			trace("Shell done()");			//once everything else is loaded, init the main			initMain();		}				private function startMain():void{			trace("Shell startMain()");			//appData.main=main;			main.alpha=0;			TweenLite.to(main, .5, {alpha:1});			addChild(main);			//main.Main.init();			//main.init();			appData.eventManager.dispatch("main", {type:"init"});		}				private function removeProgress():void{			progressBar.graphics.clear();			removeChild(progressBar);			progressBar=null;		}		//*****Event Handlers				//main		private function onMainLoaded(e:Event):void{			trace("Shell onMainLoaded()");						appData.main=new Object();			appData.main.height=mainLoader.contentLoaderInfo.height;			appData.main.width=mainLoader.contentLoaderInfo.width;			trace("appData.main.width=="+appData.main.width);			trace("appData.main.height=="+appData.main.height);						mainLoader.contentLoaderInfo.removeEventListener("complete", onMainLoaded);			mainLoader.contentLoaderInfo.removeEventListener("progress", onMainProgress);			main=Sprite(mainLoader.content);						bandwidth.endTime=new Date();			bandwidth.calcBandwidth();						startMain();						progressBar.graphics.moveTo(0, 0);			progressBar.graphics.lineStyle(progressH,progressFill);			progressBar.graphics.lineTo(progressW, 0);			progressBar.alpha=0;		}				private function onMainProgress(e:ProgressEvent):void{			progressBar.graphics.lineStyle(progressH,progressFill);			progressBar.graphics.lineTo((progressW*e.bytesLoaded)/e.bytesTotal, 0);						bandwidth.totalBytes=e.bytesTotal;			//bandwidth.progressArray.push({bytesLoaded:e.bytesLoaded,bytesTotal:e.bytesTotal, time:new Date()});		}				//stage		private function onAddedToStage(e:Event):void{			trace("Shell onAddedToStage()");						removeEventListener(Event.ADDED_TO_STAGE, onAddedToStage);						stage.addEventListener(KeyboardEvent.KEY_DOWN, onKey, false);						//check if the swf is a local file or not			if(stage.loaderInfo.url.indexOf("file:")!=-1){				trace("Shell is local");				appData.isLocal=true;			} else {				trace("Shell is not local");				appData.isLocal=false;			}						appData.stageWidth=stage.stageWidth;			appData.stageHeight=stage.stageHeight;						doneAA.stageDone=true;			checkDone();		}				//xml		private function onXMLLoaded(e:Event):void{			trace("Shell onXMLLoaded()");						xmlLoader.removeEventListener("complete", onXMLLoaded);						appData.mainXML=new XML(e.target.data);			trace("appData.mainXML=="+appData.mainXML);						doneAA.xmlDone=true;			checkDone();		}				//flashvars		private function onLoaderComplete(e:Event):void{			trace("Shell onLoaderComplete() - flashvars loaded");						appData.flashVars=this.loaderInfo.parameters;			loaderInfo.removeEventListener(Event.COMPLETE, onLoaderComplete);						for(var item in appData.flashVars){				trace("appData.flashVars."+item+"=="+appData.flashVars[item]);			}						initXML();	//this is here in case the flashvars has the xml file 						doneAA.fvDone=true;			checkDone();		}						//keyboard		private function onKey(e:KeyboardEvent):void{			//trace("Shell.onKey()");			appData.eventManager.dispatch("keyboard", {keyboardEvent:e});					}			}}